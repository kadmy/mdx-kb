# Проект "Ковчег": Архитектура и Процессы Базы Знаний (Финальная Версия)

## 1. Введение

### 1.1. Концепция "Ковчега"

**Основная Цель:** Создание и управление семантической Базой Знаний (БЗ), посвященной восстановлению и исследованию доцерковной евангельской веры в ее исконном еврейском контексте первого века. Проект призван служить "Ковчегом" для сохранения и структурирования этих знаний.

**Предметная Область:** Учение Йешуа и Его первых учеников до формирования институциональной церкви, с акцентом на еврейский бэкграунд, Танах, Заветы и терминологию.

**Ключевая Проблема ("Размазанность Знания"):** Глубокие богословские и культурные концепции (как "эмуна", "брит", "Тора", "Царство") не являются изолированными определениями. Их смысл "размазан" по множеству источников (Писание, транскрипции обсуждений), контекстов и толкований.

**Решение:** Мы не боремся с "размазанностью", а _управляем_ ею с помощью семантической разметки и автоматической консолидации. Мы создаем систему, которая позволяет:

1. **Распределять Знания:** Семантически размечать фрагменты знаний в момент их создания (вручную через редактор или автоматически с помощью LLM из транскрипций).
    
2. **Консолидировать Знания:** Автоматически собирать все "размазанные" фрагменты, связанные с одной концепцией, в единые динамические "хабы" (страницы-глоссарии).
    
3. **Извлекать Знания в Контексте:** Предоставлять пользователям (через LLM-ассистента) ответы, основанные на релевантных фрагментах знаний, с учетом их происхождения и связей.
    

### 1.2. Технологический Подход

- **Контент:** **MDX** (Markdown + JSX) для встраивания семантических компонентов.
    
- **Редактор:** Frontend на **SolidJS** с **Monaco Editor**.
    
- **Бэкенд:** **FastAPI** (Python) для API и бизнес-логики.
    
- **База Данных:** **PostgreSQL** для структурированных данных + расширение **PGVector** для семантического поиска.
    
- **Хостинг:** **Self-hosted** на локальном Linux-хосте со статическим IP, проксируемый через **Nginx** на **VPS**.
    

## 2. Архитектура

### 2.1. Сетевая Архитектура

```
graph LR
    subgraph "Интернет"
        U[Пользователь / Редактор] -->|HTTPS: kb.yeshua.im| V(VPS: Nginx Proxy);
    end

    subgraph "Локальная сеть"
        V -->|Проброс порта / Статический IP| H(Локальный Linux Host);
        H --> DB[(PostgreSQL + PGVector)];
        H --> FAPI[FastAPI Движок];
        FAPI --> DB;
        FAPI -->|Опционально| LLM(LLM API / Локальная модель);
    end

    style V fill:#f9f,stroke:#333,stroke-width:2px;
    style H fill:#ccf,stroke:#333,stroke-width:2px;
    style DB fill:#9cf,stroke:#333,stroke-width:2px;
    style FAPI fill:#9cf,stroke:#333,stroke-width:2px;
    style LLM fill:#fcf,stroke:#333,stroke-width:1px,stroke-dasharray: 5 5;
```

- **Пользователи/Редакторы** обращаются к `kb.yeshua.im`.
    
- **VPS с Nginx** проксирует запросы на статический IP локального хоста.
    
- **Локальный Linux Host** содержит FastAPI бэкенд и PostgreSQL базу данных.
    

### 2.2. Программная Архитектура

```
graph TD
    subgraph "Источники Данных"
        A["Транскрипции Собраний (.txt)"]
    end

    subgraph "Бэкенд: FastAPI (Локальный Хост)"
        B("FastAPI Движок")
        C("LLM API / Локальная модель")
        D("PostgreSQL")
        E("PGVector")

        B -- "Обработка транскрипций" --> C
        C -- "Извлеченные фрагменты (JSON)" --> B
        B -- "Сохранение/Чтение данных" --> D
        B -- "Генерация/Поиск Эмбеддингов" --> E
        D -- "Хранение Эмбеддингов" --> E
    end

    subgraph "Интерфейс Редактора (SolidJS)"
        F["GUI Редактора (Monaco)"]
        G["Предпросмотр MDX"]
        H["Runtime MDX Компилятор (в браузере)"]

        F -- "Загрузка/Сохранение MDX" --> B
        F -- "MDX код" --> H
        H -- "Скомпилированный Компонент" --> G
        D -- "Данные для консолидации" --> B -- "API" --> G_AGF("AutoGeneratedFragments в Предпросмотре");
        subgraph G
            G_AGF
        end
    end

    subgraph "Интерфейс Пользователя (Веб-страница)"
        I["Пользовательский Интерфейс (Чат)"]
        J["LLM Ассистент (RAG)"]

        I -- "Запрос + Фасеты" --> B
        B -- "Поиск (SQL + Vector)" --> D
        B -- "Поиск (Vector)" --> E
        D -- "Релевантные Документы/Фрагменты" --> B
        E -- "Релевантные Фрагменты (по схожести)" --> B
        B -- "Контекст + Запрос" --> C
        C -- "Сгенерированный Ответ" --> B
        B -- "Ответ Ассистента" --> I
        I -- "Отображение" --> J
    end

    %% Стилизация
    style A fill:#f9f,stroke:#333,stroke-width:2px
    style B fill:#ccf,stroke:#333,stroke-width:2px
    style C fill:#fcf,stroke:#333,stroke-width:1px,stroke-dasharray: 5 5
    style D fill:#9cf,stroke:#333,stroke-width:2px
    style E fill:#9cf,stroke:#333,stroke-width:2px
    style F fill:#9f9,stroke:#333,stroke-width:2px
    style G fill:#9f9,stroke:#333,stroke-width:2px
    style H fill:#9f9,stroke:#333,stroke-width:2px
    style I fill:#ff9,stroke:#333,stroke-width:2px
    style J fill:#ff9,stroke:#333,stroke-width:2px
    style G_AGF fill:#bfb,stroke:#333,stroke-width:1px;
```

- **Редактор (SolidJS):** Позволяет создавать и размечать MDX документы, используя runtime-компиляцию для предпросмотра. Взаимодействует с бэкендом для сохранения/загрузки.
    
- **Бэкенд (FastAPI):** Обрабатывает CRUD операции, управляет LLM-пайплайном, выполняет поиск (SQL + векторный), предоставляет API для редактора и пользовательского интерфейса.
    
- **Пользовательский Интерфейс:** Веб-страница с чатом, где LLM-ассистент отвечает на вопросы, используя RAG (Retrieval-Augmented Generation) на основе данных из PostgreSQL/PGVector.
    

### 2.3. Структура Базы Знаний (Дерево Каталогов)

Предлагаемая иерархия для организации MDX файлов (пути используются как идентификаторы в БД):

```
/ (Корень БЗ)
├── 01-doctrine/                  (Основы Учения)
│   ├── 03-covenants/             (Заветы)
│   │   ├── avraham.mdx
│   │   └── yeshua.mdx
│   └── ...
├── 02-scripture/                 (Толкование Писания)
│   ├── tanakh/
│   └── apostolic/
├── 03-context/                   (Исторический и культурный контекст)
│   ├── history/
│   └── culture/
├── 04-analysis/                  (Синтез и сравнительный анализ)
│   └── covenant-continuity.mdx
├── 05-people/                    (Биографический справочник)
│   ├── avraham.mdx
│   └── ...
└── 06-concepts/                  (Глоссарий / Концептуальные Хабы)
    ├── emunah.mdx                (Хаб для "Эмуна")
    └── brit.mdx                  (Хаб для "Брит")
```

_(Полная структура приведена в предыдущих обсуждениях)_

## 3. Технологии и Данные

### 3.1. Стек Технологий

- **Frontend Редактора:** SolidJS, Monaco Editor, MDX runtime (`@mdx-js/mdx`)
    
- **Backend:** Python, FastAPI
    
- **База Данных:** PostgreSQL + PGVector
    
- **Прокси:** Nginx (на VPS)
    
- **Хостинг Бэкенда:** Локальный Linux хост (Neon)
    
- **LLM:** Внешнее API (Gemini и т.д.) или локальная модель
    

### 3.2. Формат Данных: MDX

Основной контент хранится в виде MDX файлов, что позволяет сочетать Markdown с JSX-компонентами для семантической разметки.

### 3.3. Схема Frontmatter (Метаданные Документа)

Во `frontmatter` каждого MDX-файла используется структурированная схема для организации и фильтрации (фасеты):

```
---
# === 1. Основные Метаданные (Для SEO и Навигации) ===
title: 'Завет Авраама: Основание веры'
description: 'Глубокий разбор Завета с Авраамом...'
date: '2023-11-05' # Дата создания/обновления
draft: false # Черновик (true) / Опубликовано (false)

# === 2. Организационные "Фасеты" (Для RAG и Фильтров) ===
content_type: 'study' # study | lecture | exegesis | reference | analysis | qa
level: 'level_2_foundational' # level_1_beginner | ... | level_4_academic
series: 'Основы Завета' # Название серии (текст)
part: 1 # Номер части в серии (число)
origin: 'origin_transcript_derived' # systematic | transcript_derived | community_note
---
```

### 3.4. Схема Базы Данных PostgreSQL (Ключевые Таблицы)

- `documents`: `id`, `path`, `mdx_content`, `created_at`, `updated_at`, `title`, `description`, `date`, `draft`, `content_type`, `level`, `series`, `part`, `origin`, `embedding` (vector, опционально, для всего документа).
    
- `concepts`: `id` (slug), `title`, `description`, `category`.
    
- `terms`: `id` (slug), `definition`, `etymology`, `category`.
    
- `knowledge_fragments`: `id`, `document_id` (FK), `concept_id` (FK), `aspect`, `quintessence`, `original_quote`, `source_id`, `location_marker`, `speakers`, `embedding` (vector).
    
- `relationships`: Таблицы связей (e.g., `document_concepts`, `term_related_concepts`).
    

## 4. Арсенал MDX Компонентов (Семантические Теги)

Полный список компонентов для разметки контента (реализуются как SolidJS компоненты):

- **Структурные Блоки:** `<ArgumentSection>`, `<SupportPoint>`, `<CounterArgument>`, `<Rebuttal>`
    
- **Блоки Контента:** `<BibleVerse>`, `<Definition>`, `<JewishContext>`, `<Callout>`, `<Ritual>`
    
- **Inline-Сущности:** `<Term>`, `<PersonRef>`, `<ScriptureRef>`, `<OriginalWord>`, `<SourceRef>`, `<PlaceRef>`
    
- **Управление Знаниями:** `<Concept>`, `<ConceptLink>`, `<KnowledgeFragment>`, `<AutoGeneratedFragments>`
    

_(Подробное описание каждого компонента и его атрибутов приведено в предыдущих обсуждениях)_

## 5. Контентный Пайплайн (LLM)

Процесс ETL (Extract, Transform, Load) для преобразования транскрипций в структурированные `KnowledgeFragment`.

### 5.1. Системный Промпт для LLM

(Приведен полный текст промпта в предыдущих обсуждениях)

**Ключевые аспекты промпта:**

- **Роль:** Аналитик Базы Знаний.
    
- **Задача:** Извлечь `KnowledgeFragment` из транскрипций, отделив "квинтэссенцию" от "шума".
    
- **Вход:** JSON (`source_id`, `transcript_chunks`, `mode`, `filter_concept`).
    
- **Выход:** Строго JSON (`extracted_fragments`, `discovered_concepts`).
    
- **Схема `extracted_fragments`:** `concept_id`, `concept_name`, `aspect`, `quintessence`, `original_quote`, `source_id`, `location_marker`, `speakers`.
    
- **Аспекты:** `definition`, `interpretation`, `contextual`, `comparative`, `problem`, `application`, `polemic`, `relational`, `etymological`, `prophetic`.
    
- **Режимы:** `FILTER` (поиск конкретной концепции), `DISCOVERY` (поиск и предложение новых концепций).
    

### 5.2. Процесс

1. Транскрипция подается на вход FastAPI эндпоинта.
    
2. FastAPI вызывает LLM API с системным промптом и данными транскрипции.
    
3. LLM возвращает JSON с извлеченными фрагментами.
    
4. FastAPI сохраняет результат в БД для ревью редактором.
    
5. Редактор через GUI проверяет, редактирует (если нужно) и утверждает фрагменты.
    
6. Утвержденные фрагменты попадают в основную таблицу `knowledge_fragments`, для них генерируются эмбеддинги (PGVector).
    

## 6. План Разработки (Перечень Работ)

Адаптированный план реорганизации `mdx-sandbox` под архитектуру "Ковчега":

- **Этап 1: Адаптация Frontend Редактора (SolidJS)**
    
    - (1.1) Обновить Frontmatter (форма и валидация).
        
    - (1.2) Реализовать все MDX Компоненты.
        
    - (1.3) Улучшить Monaco Editor (подсветка, автодополнение).
        
    - (1.4) Убрать Локальное API из Vite.
        
- **Этап 2: Настройка Бэкенда (FastAPI) и Базы Данных (PostgreSQL)**
    
    - (2.1) Настроить FastAPI Проект.
        
    - (2.2) Спроектировать и создать Схему БД PostgreSQL.
        
    - (2.3) Настроить PGVector.
        
    - (2.4) Реализовать Аутентификацию.
        
- **Этап 3: Реализация API (FastAPI)**
    
    - (3.1) CRUD для Документов.
        
    - (3.2) API для Справочников (Концепты, Термины).
        
    - (3.3) API для Фрагментов Знаний.
        
    - (3.4) API для Консолидации (`/concepts/{id}/fragments`).
        
- **Этап 4: Интеграция Редактора с Бэкендом**
    
    - (4.1) Подключить Редактор к FastAPI API.
        
    - (4.2) Интегрировать `AutoGeneratedFragments` с API.
        
- **Этап 5: LLM Пайплайн и Консолидация (Бэкенд)**
    
    - (5.1) Реализовать LLM Пайплайн в FastAPI.
        
    - (5.2) Интерфейс Ревью Фрагментов (в Редакторе GUI).
        
    - (5.3) Реализовать Консолидацию Фрагментов из MDX (опционально, для ручной разметки).
        
    - (5.4) Генерация Эмбеддингов (PGVector).
        
- **Этап 6: Пользовательское Приложение (Отдельный Frontend)**
    
    - (6.1) Создать Frontend для Пользователей.
        
    - (6.2) Реализовать Выбор Фасетов.
        
    - (6.3) Интеграция с LLM Ассистентом (RAG через FastAPI).
        
    - (6.4) Динамическое Формирование Контента.
        
- **Этап 7: Развертывание и Инфраструктура**
    
    - (7.1) Настроить Nginx Proxy на VPS.
        
    - (7.2) Обеспечить Стабильность Локального Хоста (автозапуск, бэкапы).
        

## 7. Примеры MDX Документов

(Приведены полные примеры документов `avraham.mdx`, `yeshua.mdx`, `covenant-continuity.mdx` с использованием компонентов в предыдущих обсуждениях. Они иллюстрируют применение семантической разметки и связей).

## 8. Заключение

Проект "Ковчег" представляет собой комплексную систему для управления специализированной базой знаний. Используя MDX для семантической разметки, FastAPI и PostgreSQL/PGVector для бэкенда и хранения данных, а также LLM для автоматизации обработки контента, система позволяет эффективно управлять "размазанными" знаниями, консолидировать их и предоставлять пользователям релевантную информацию в контексте через RAG-ассистента. Архитектура с self-hosted бэкендом и VPS-прокси обеспечивает контроль над данными и инфраструктурой.